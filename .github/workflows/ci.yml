########################################################################
# Control Tower – CI Pipeline
########################################################################
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "22"

jobs:
  # ── Backend Lint & Type Check ────────────────────────────
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          cd backend
          pip install -e ".[dev]"
      - name: Ruff lint
        run: cd backend && ruff check app/
      - name: Ruff format check
        run: cd backend && ruff format --check app/
      - name: Mypy type check
        run: cd backend && mypy app/ --ignore-missing-imports

  # ── Backend Tests ────────────────────────────────────────
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: control_tower_test
          POSTGRES_USER: ct_user
          POSTGRES_PASSWORD: ct_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql+asyncpg://ct_user:ct_password@localhost:5432/control_tower_test
      DATABASE_URL_SYNC: postgresql+psycopg2://ct_user:ct_password@localhost:5432/control_tower_test
      ENVIRONMENT: development
      ENABLE_OPA: "false"
      ENABLE_KAFKA: "false"
      ENABLE_TEMPORAL: "false"
      ENABLE_OTEL: "false"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          cd backend
          pip install -e ".[dev]"
      - name: Run migrations
        run: cd backend && alembic upgrade head
      - name: Run tests
        run: cd backend && python -m pytest tests/ -v --cov=app --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml

  # ── Frontend Lint & Build ────────────────────────────────
  frontend-lint:
    name: Frontend Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        run: cd frontend && npm ci
      - name: Lint
        run: cd frontend && npm run lint
      - name: Type check
        run: cd frontend && npx tsc --noEmit
      - name: Build
        run: cd frontend && npm run build

  # ── OPA Policy Tests ─────────────────────────────────────
  policy-test:
    name: OPA Policy Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.70.0/opa_linux_amd64_static
          chmod 755 opa
          sudo mv opa /usr/local/bin/
      - name: Test policies
        run: |
          cd policies/opa
          opa check *.rego
          echo "All policies validated."

  # ── Docker Build ─────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test, frontend-lint, policy-test]
    steps:
      - uses: actions/checkout@v4
      - name: Build backend image
        run: docker build -t control-tower-backend:latest ./backend
      - name: Build frontend image
        run: docker build -t control-tower-frontend:latest ./frontend
