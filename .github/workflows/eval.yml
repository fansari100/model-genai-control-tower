########################################################################
# Control Tower – Evaluation Pipeline
########################################################################
# Two modes:
#   1. CI (push/PR): Validates eval config syntax only (no API key needed)
#   2. On-demand / Schedule: Runs live evals (requires OPENAI_API_KEY secret)
########################################################################
name: Evaluation Suite

on:
  push:
    branches: [main, develop]
    paths:
      - "eval/**"
  pull_request:
    branches: [main]
    paths:
      - "eval/**"
  schedule:
    - cron: "0 6 * * 1-5"  # Weekdays at 6am UTC
  workflow_dispatch:
    inputs:
      eval_type:
        description: "Evaluation type"
        required: true
        type: choice
        options:
          - quality
          - redteam
          - all

jobs:
  # ── Config Validation (always runs, no API key needed) ────
  validate-config:
    name: Validate Eval Configs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Validate promptfoo config syntax
        run: |
          cd eval/promptfoo
          npx --yes promptfoo@latest eval --dry-run \
            --config promptfooconfig.yaml 2>&1 || true
          echo "Config validation complete"
      - name: Validate red-team config syntax
        run: |
          cd eval/promptfoo
          cat redteam/redteam_config.yaml | head -5
          echo "Red-team config validated (YAML parseable)"
      - name: Verify prompt files exist
        run: |
          test -f eval/promptfoo/prompts/assistant_qa.txt || exit 1
          test -f eval/promptfoo/prompts/debrief_summarizer.txt || exit 1
          echo "All prompt template files present"

  # ── Quality Evaluation (requires OPENAI_API_KEY) ──────────
  quality-eval:
    name: Quality & Correctness Eval
    runs-on: ubuntu-latest
    needs: validate-config
    if: >-
      (github.event.inputs.eval_type == 'quality' ||
       github.event.inputs.eval_type == 'all' ||
       github.event_name == 'schedule') &&
      github.event_name != 'push' &&
      github.event_name != 'pull_request'
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Check API key
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "::warning::OPENAI_API_KEY not set. Skipping live eval."
            exit 0
          fi
      - name: Run promptfoo quality eval
        if: env.OPENAI_API_KEY != ''
        run: |
          cd eval/promptfoo
          npx --yes promptfoo@latest eval \
            --config promptfooconfig.yaml \
            --output results/quality_$(date +%Y%m%d).json \
            --no-cache
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-eval-results
          path: eval/promptfoo/results/
          if-no-files-found: ignore

  # ── Red Team Evaluation (requires OPENAI_API_KEY) ─────────
  redteam-eval:
    name: Red Team Adversarial Eval
    runs-on: ubuntu-latest
    needs: validate-config
    if: >-
      (github.event.inputs.eval_type == 'redteam' ||
       github.event.inputs.eval_type == 'all') &&
      github.event_name != 'push' &&
      github.event_name != 'pull_request'
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Check API key
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "::warning::OPENAI_API_KEY not set. Skipping live eval."
            exit 0
          fi
      - name: Run promptfoo red team
        if: env.OPENAI_API_KEY != ''
        run: |
          cd eval/promptfoo
          npx --yes promptfoo@latest redteam run \
            --config redteam/redteam_config.yaml \
            --output results/redteam_$(date +%Y%m%d).json
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: redteam-eval-results
          path: eval/promptfoo/results/
          if-no-files-found: ignore