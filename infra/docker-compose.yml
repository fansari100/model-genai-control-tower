########################################################################
# Control Tower – Docker Compose (Full Development Stack)
########################################################################
# Services:
#   - PostgreSQL 17 (primary data store + pgvector)
#   - MinIO (S3-compatible evidence store)
#   - Redpanda (Kafka-compatible event bus)
#   - Temporal (workflow orchestration)
#   - OPA (policy-as-code engine)
#   - Keycloak (OIDC auth provider)
#   - OpenTelemetry Collector
#   - Arize Phoenix (LLM tracing/eval)
#   - Prometheus + Grafana (infra metrics)
########################################################################

services:
  # ── PostgreSQL 17 with pgvector ──────────────────────────
  postgres:
    image: pgvector/pgvector:pg17
    container_name: ct-postgres
    environment:
      POSTGRES_DB: control_tower
      POSTGRES_USER: ct_user
      POSTGRES_PASSWORD: ct_password
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ct_user -d control_tower"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ── MinIO (S3-compatible evidence store) ─────────────────
  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: ct-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - miniodata:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── MinIO bucket init ────────────────────────────────────
  minio-init:
    image: minio/mc
    container_name: ct-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing local/ct-evidence;
      mc mb --ignore-existing local/ct-artifacts;
      mc anonymous set download local/ct-artifacts;
      exit 0;
      "

  # ── Redpanda (Kafka-compatible event bus) ────────────────
  redpanda:
    image: redpandadata/redpanda:v24.3.1
    container_name: ct-redpanda
    command:
      - redpanda start
      - --smp 1
      - --memory 512M
      - --overprovisioned
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"
      - "8082:8082"
    volumes:
      - redpandadata:/var/lib/redpanda/data

  # ── Temporal (workflow orchestration) ────────────────────
  temporal:
    image: temporalio/auto-setup:1.25.2
    container_name: ct-temporal
    environment:
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_USER: ct_user
      POSTGRES_PWD: ct_password
      POSTGRES_SEEDS: postgres
      DYNAMIC_CONFIG_FILE_PATH: /etc/temporal/config/dynamicconfig/development.yaml
    ports:
      - "7233:7233"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./temporal-config:/etc/temporal/config/dynamicconfig

  temporal-ui:
    image: temporalio/ui:2.31.2
    container_name: ct-temporal-ui
    environment:
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_CORS_ORIGINS: http://localhost:3000
    ports:
      - "8088:8080"
    depends_on:
      - temporal

  # ── OPA (policy engine) ─────────────────────────────────
  opa:
    image: openpolicyagent/opa:0.70.0
    container_name: ct-opa
    command:
      - run
      - --server
      - --log-level=info
      - --set=decision_logs.console=true
      - /policies
    ports:
      - "8181:8181"
    volumes:
      - ../policies/opa:/policies

  # ── Keycloak (OIDC auth) ────────────────────────────────
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: ct-keycloak
    command: start-dev --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak:/opt/keycloak/data/import

  # ── OpenTelemetry Collector ─────────────────────────────
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.115.0
    container_name: ct-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics
      - "8889:8889"   # Prometheus exporter
    volumes:
      - ./otel/otel-collector-config.yaml:/etc/otel-collector-config.yaml

  # ── Arize Phoenix (LLM tracing & eval) ──────────────────
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: ct-phoenix
    ports:
      - "6006:6006"
      - "4317"        # OTLP gRPC (internal)
    environment:
      PHOENIX_WORKING_DIR: /data
    volumes:
      - phoenixdata:/data

  # ── Prometheus ──────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: ct-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - promdata:/prometheus

  # ── Grafana ─────────────────────────────────────────────
  grafana:
    image: grafana/grafana:11.4.0
    container_name: ct-grafana
    ports:
      - "3002:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_AUTH_ANONYMOUS_ENABLED: true
    volumes:
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - grafanadata:/var/lib/grafana

volumes:
  pgdata:
  miniodata:
  redpandadata:
  promdata:
  grafanadata:
  phoenixdata:
